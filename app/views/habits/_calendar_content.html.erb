<% # month is beginning_of_month; checked_dates is a Set of Date %>
<% start_date = month.beginning_of_month %>
<% end_date = month.end_of_month %>
<% first_wday = start_date.wday %>
<% today = Time.use_zone(current_user.timezone) { Time.zone.today } %>
<% prev_month = (start_date - 1.month).strftime("%Y-%m") %>
<% next_month = (start_date + 1.month).strftime("%Y-%m") %>
<% next_month_date = start_date + 1.month %>
<% allow_next = next_month_date <= today %>

<div class="p-4 sm:p-5">
  <div class="flex items-center justify-between gap-2 mb-3 sm:mb-4">
    <h3 class="text-base font-semibold text-gray-900 truncate min-w-0"><%= habit.name %></h3>
    <button type="button" data-action="click->habit-calendar#close" class="flex-shrink-0 min-w-[44px] min-h-[44px] flex items-center justify-center -m-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition-colors touch-manipulation" aria-label="Close">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
  </div>

  <div class="flex items-center justify-between gap-2 mb-3 sm:mb-4">
    <%= link_to calendar_habit_path(habit, month: prev_month), data: { turbo_frame: "habit_calendar" }, class: "min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg text-sm font-medium text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors touch-manipulation" do %>
      ← <%= (start_date - 1.month).strftime("%b") %>
    <% end %>
    <span class="text-base font-semibold text-gray-800 truncate"><%= start_date.strftime("%B %Y") %></span>
    <% if allow_next %>
      <%= link_to calendar_habit_path(habit, month: next_month), data: { turbo_frame: "habit_calendar" }, class: "min-w-[44px] min-h-[44px] flex items-center justify-center rounded-lg text-sm font-medium text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors touch-manipulation" do %>
        <%= (start_date + 1.month).strftime("%b") %> →
      <% end %>
    <% else %>
      <span class="min-w-[44px] min-h-[44px] flex items-center justify-center text-sm text-gray-400">—</span>
    <% end %>
  </div>

  <div class="grid grid-cols-7 gap-1 sm:gap-1.5">
    <% %w[S M T W T F S].each do |day| %>
      <div class="text-center text-xs font-semibold text-gray-500 py-1"><%= day %></div>
    <% end %>
    <% first_wday.times do %>
      <div class="aspect-square min-w-0 rounded-lg bg-gray-100/50"></div>
    <% end %>
    <% (start_date..end_date).each do |date| %>
      <% checked = checked_dates.include?(date) %>
      <% is_today = date == today %>
      <div class="aspect-square min-w-0 rounded-lg flex items-center justify-center text-xs sm:text-sm font-medium <%= checked ? 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white' : (is_today ? 'ring-2 ring-indigo-400 bg-indigo-50 text-gray-700' : 'bg-gray-100 text-gray-600') %>">
        <%= date.day %>
      </div>
    <% end %>
    <% total_cells = first_wday + end_date.day %>
    <% pad = (7 - total_cells % 7) % 7 %>
    <% pad.times do %><div class="aspect-square min-w-0 rounded-lg bg-gray-100/50"></div><% end %>
  </div>
</div>
